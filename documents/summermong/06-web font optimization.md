# 웹폰트 최적화

### 웹 폰트

- 이전에는 유저의 시스템에 설치된 폰트만 사용할 수 있어 웹 페이지에 표시되는 글자의 폰트 선택이 크게 제한되었고 웹 페이지를 사용하는 모든 유저가 동일한 폰트로 일관된 디자인을 경험할 수 없었음
- 웹 폰트는 로컬의 폰트 설치 상황과 상관없이 웹에서 항상 원하는 타이포그래피를 사용할 수 있게 하는 기술

### 기본 사용법

- CSS의 @font-face 규칙을 사용해 적용한다.
- font-family로 사용할 웹 폰트의 이름을 지정한다. (폰트 이름과 일치하지 않아도 되지만 유지보수를 위해 유사하게 하는 것을 권장한다.)
- src로 폰트 파일의 경로와 폰트 형식을 지정한다. (url(), format())

만약 웹 폰트 로딩에 실패하면 다음으로 선언된 폰트가 렌더링되는데 이러한 폰트를 폴백 폰트(fallback font)라고 한다.

### 웹 폰트가 동작하는 방식

- 웹 폰트는 온라인 상에서 폰트 파일을 다운로드해 사용하는 것
- 웹 폰트를 사용하는 페이지에 접근할 때, 웹 서버 이외의 또 다른 서버로 웹 폰트를 요청함

![image](https://d2.naver.com/content/images/2018/12/helloworld-201812-webfont_04.png)

T0: 브라우저가 HTML 문서를 요청한다.
T1: HTML 응답이 오면 DOM을 구성한다. 브라우저는 CSS, JS 등 기타 리소스를 요청한다.
T2: 모든 CSS 콘텐츠를 수신해 CSSOM을 구성한다. 그 후 CSSOM과 DOM 트리를 결합 시켜 렌더링 트리를 구성하고 이 때 폰트 리소스를 요청한다.
**T3: 콘텐츠를 화면에 그린다. 이 때 폰트를 사용할 수 없으면 브라우저는 글자를 렌더링하지 않을 수도 있다.**

CSSOM을 생성하는 과정에서 외부 웹 폰트 링크로 정의된 부분을 만나고, 해당 폰트 파일을 다운한다. 하지만 Paint 단계에서 웹 폰트 파일처럼 외부 링크로 연결된 파일의 다운로드가 완료되지 않았으면 브라우저는 해당 자원을 사용하는 콘텐츠의 렌더링을 차단한다.

=> 폰트 리소스 요청은 다른 리소스 요청보다 늦게 진행되며 (html, CSS, JS 등) 콘텐츠를 화면에 그리는 동안 폰트 리소스 응답이 늦어질 경우 FOIT, FOUT이 발생할 수 있다.
=> 텍스트 렌더링 지연으로 FCP(First Content Paint)가 지연되고, 이로 인해 LCP(Largest Content Paint)도 지연되는 등 웹 성능에도 영향을 준다.

### FOIT, FOUT란?

![image](https://blog.kakaocdn.net/dn/pmpIG/btrSM4hxeFQ/MSWRbxoF8K3H29MacOi8wK/img.gif)

우리가 웹사이트에 진입할 때 글자가 늦게 뜨거나 폰트가 느리게 적용되는 현상이 있다.
이러한 현상을 FOIT, FOUT이라고 한다.

FOIT(Flash Of Invisible Text): 브라우저가 폰트를 다운하기 전까지 글자가 안 보이는 현상
FOUT(Flas Of Unstyled Text): 브라우저가 폰트를 다운하기 전까지 폰트가 적용되지 않는 현상

### 그래서 어떻게 최적화 하는가

#### 폰트 파일 용량 줄이기

![image](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbZAyBG%2FbtrSN0e1VIm%2FKbBWSIEtD2VwIOSaUAkdFk%2Fimg.png)

- 웹 폰트의 형식은 TTF, OTF외에도 WOFF, WOFF2 등이 있다.
- WOFF2는 WOFF를 개선한 버전으로, 폰트 형식 중 가장 압축률이 좋다.
- WOFF2는 IE를 제외한 모든 브라우저에서 사용할 수 있지만 WOFF를 지원하지 않는 경우 WOFF를 사용하면 된다. (이 역시 사용할 수 없다면 다른 형식을 폴백 폰트로 사용하면 된다.)

#### 서브셋 폰트 사용하기

- 서브셋 폰트란 폰트 파일에서 불필요한 글자를 제거하고 사용할 글자만 남겨둔 폰트를 말한다.
- 한글 폰트 파일은 영문 폰트 파일보다 훨씬 용량이 크다.
- 최근 출시된 한글 웹 폰트들은 대부분 실생활에서 사용할 글자만 남긴 2,350자의 서브셋 폰트지만 서브셋 폰트가 아니라면 직접 만들어 사용할 수도 있다. (서브셋 폰트 메이커 OR fontTools)
- 또는 유니코드로 지정된 글자에만 웹 폰트를 적용하는 unicode-range 속성을 사용하는 것도 방법이다.

### 웹 폰트 리소스 먼저 로드하기

- 폰트 리소스 요청이 다른 리소스보다 늦게 요청되어 렌더링 지연이 발생하기 때문에 폰트 리소스를 먼저 요청하는 방법
- rel="preload"를 작성하면 브라우저가 폰트 리소스를 우선적으로 로드하게 된다.
- 이 옵션은 IE, Edge, Firefox에서는 지원되지 않는다.
- preload 옵션으로 다운하는 리소스가 많아질수록 처음 렌더링이 늦어지는 문제점이 있기 때문에 중요도가 높고 먼저 렌더링 되어야 하는 리소스만 지정하는 것이 좋다.

### 의도적인 FOUT 방식으로 텍스트를 항상 노출하기

#### Font Face Observer 라이브러리 사용하기

![image](https://d2.naver.com/content/images/2018/12/helloworld-201812-webfont_15.png)

- 해당 라이브러리는 웹 폰트의 로딩 상태를 추적하는 폰트 로더로 파일 크기가 작고 실행 속도가 빠르다.
- CSS에는 웹 폰트를 적용하지 않은 상태 / 적용한 상태를 선언하고 전자의 CSS를 먼저 적용 시킨다.
- JS에는 웹 폰트 이름을 파라미터로 하는 FontFaceObserver 객체를 생성하고, load 메서드로 로딩이 완료될 때 CSS 클래스를 추가한다.

+) 폰트 로딩 API인 FontFace로도 가능하다.

#### CSS의 font-display 속성 사용하기

- 외부 라이브러리 없이 웹 폰트의 로딩 상태에 따른 동작을 지정할 수 있다.
- font-display는 모든 브라우저가 지원한다.
- auto, block, swap, fallback, optional 5가지의 옵션이 있다.
- auto는 브라우저의 기본 동작이다.
- block은 FOIT과 동일하게 작동하는 옵션으로, 최대 3초동안 웹 폰트가 로딩되지 않을 경우 텍스트를 렌더링하지 않는다. 3초 후 폴백 폰트를 적용하다 웹 폰트 로딩이 완료되면 웹 폰트를 적용한다.
- swap은 FOUT과 동일하게 작동하는 옵션으로, 먼저 폴백 폰트로 텍스트를 렌더링하고 웹 폰트 로딩이 완료되면 웹 폰트를 적용한다. 즉 웹 폰트의 로딩 여부와 무관하게 항상 텍스트가보인다.
- fallback은 우선 100ms 동안 텍스트가 보이지 않다가 이후 폴백 폰트로 렌더링된다. 2초동안 swap time이 있어 이 안에 로딩이 완료되면 웹 폰트로 전환한다. 단 2초가 지나면 웹 폰트가 다운되어도 폴백 폰트를 계속 유지한다. 대신 다운된 웹 폰트는 캐시에 저장되어 새로고침 할 때 바로 적용된다.
- optional은 우선 100ms동안 텍스트가 보이지 않다가 이후 폴백 폰트로 전환한다. 웹 폰트를 다운하지만 브라우저가 네트워크 상태를 파악해 웹 폰트 전환 여부를 결정한다. 연결 상태가 나쁘면 다운을 해도 캐시에 저장만 하고 바꾸지 않는다.

=> 다만 이렇게 FOUT 방식으로 텍스트를 노출하면 레이아웃이 깨진 폰트가 적용될 수 있다. Font style matcher 앱에서 폴백 폰트와 사용할 웹 폰트를 비교하며 레이아웃을 수정하면 이러한 부작용을 최소화 할 수 있다.

---

참고
https://web.dev/articles/reduce-webfont-size?hl=ko
https://d2.naver.com/helloworld/4969726
https://yozm.wishket.com/magazine/detail/2107/
